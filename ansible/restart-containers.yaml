---
- name: Restart Docker Compose Containers
  hosts: beelink
  become: true
  vars:
    docker_compose_dir: "/srv/docker"

  tasks:
    - name: Find all compose.yml files in /srv/docker
      ansible.builtin.find:
        paths: "{{ docker_compose_dir }}"
        patterns:
          - "compose.yml"
          - "docker-compose.yml"
        recurse: true
        file_type: file
      register: compose_files

    - name: Prompt user to restart container
      ansible.builtin.pause:
        prompt: "Restart container at {{ item.path }}? (y/n)"
      loop: "{{ compose_files.files }}"
      loop_control:
        label: "{{ item.path }}"
      register: restart_prompts

    - name: Restart Docker Compose project
      ansible.builtin.command:
        cmd: docker compose up -d --build
        chdir: "{{ item.0.path | regex_replace('/[^/]+$', '') }}"
      loop: "{{ compose_files.files | zip(restart_prompts.results) | list }}"
      loop_control:
        label: "{{ item.0.path }}"
      when: item.1.user_input | default('') | lower == 'y'
      register: restart_results

    - name: Collect restart summary
      ansible.builtin.set_fact:
        restart_summary: "{{ restart_summary | default([]) + [{'name': item.0.path | regex_replace('/[^/]+$', '') | regex_replace('.*/([^/]+)$', '\\1'), 'status': 'Restarted' if (item.1.user_input | default('') | lower == 'y') else 'Skipped'}] }}"
      loop: "{{ compose_files.files | zip(restart_prompts.results) | list }}"

    - name: Show restart summary
      ansible.builtin.debug:
        msg: "{{ item.status }}: {{ item.name }}"
      loop: "{{ restart_summary }}"
      loop_control:
        label: "{{ item.status }}: {{ item.name }}"
