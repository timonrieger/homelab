- name: Provision beelink
  hosts: beelink
  become: true
  vars:
    user: timon
    cloudflared_tunnel_id: b6cad4cb-bfc4-4cb0-b0e6-2073891d169b
  tasks:
    - name: Ensure prerequisite apt packages are present
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: true

    - name: Check if Tailscale is installed
      ansible.builtin.command: which tailscale
      register: tailscale_check
      failed_when: false
      changed_when: false

    - name: Import Tailscale GPG key
      ansible.builtin.get_url:
        url: https://pkgs.tailscale.com/stable/debian/trixie.noarmor.gpg
        dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
        mode: '0644'
      when: tailscale_check.rc != 0

    - name: Add Tailscale repository
      ansible.builtin.get_url:
        url: https://pkgs.tailscale.com/stable/debian/trixie.tailscale-keyring.list
        dest: /etc/apt/sources.list.d/tailscale.list
        mode: '0644'
      when: tailscale_check.rc != 0

    - name: Install Tailscale
      ansible.builtin.apt:
        name: tailscale
        state: present
        update_cache: true
      when: tailscale_check.rc != 0

    - name: Check if Fish Shell is installed
      ansible.builtin.command: which fish
      register: fish_check
      failed_when: false
      changed_when: false

    - name: Import Fish Shell GPG key
      ansible.builtin.shell: |
        curl -fsSL https://download.opensuse.org/repositories/shells:fish:release:4/Debian_13/Release.key | gpg --dearmor -o /etc/apt/trusted.gpg.d/shells_fish_release_4.gpg
      args:
        creates: /etc/apt/trusted.gpg.d/shells_fish_release_4.gpg
      when: fish_check.rc != 0

    - name: Add Fish Shell repository
      ansible.builtin.apt_repository:
        repo: "deb http://download.opensuse.org/repositories/shells:/fish:/release:/4/Debian_13/ /"
        state: present
        filename: shells:fish:release:4

    - name: Install Fish Shell
      ansible.builtin.apt:
        name: fish
        state: present
        update_cache: true

    - name: Set default shell to fish
      ansible.builtin.user:
        name: "{{ user }}"
        shell: /usr/bin/fish

    - name: Check if cloudflared is installed
      ansible.builtin.command: which cloudflared
      register: cloudflared_check
      failed_when: false
      changed_when: false

    - name: Ensure /usr/share/keyrings exists
      ansible.builtin.file:
        path: /usr/share/keyrings
        state: directory
        mode: "0755"

    - name: Import Cloudflare GPG key (cloudflared)
      ansible.builtin.get_url:
        url: https://pkg.cloudflare.com/cloudflare-main.gpg
        dest: /usr/share/keyrings/cloudflare-main.gpg
        mode: "0644"
      when: cloudflared_check.rc != 0

    - name: Add Cloudflared apt repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main"
        state: present
        filename: cloudflared

    - name: Install cloudflared
      ansible.builtin.apt:
        name: cloudflared
        state: present
        update_cache: true

    - name: Ensure /etc/cloudflared exists
      ansible.builtin.file:
        path: /etc/cloudflared
        state: directory
        mode: "0755"

    - name: Check for existing ~/.cloudflared directory
      ansible.builtin.stat:
        path: /home/{{ user }}/.cloudflared
      register: cloudflared_user_dir_stat

    - name: Copy ~/.cloudflared contents to /etc/cloudflared (then remove from user)
      ansible.builtin.copy:
        src: /home/{{ user }}/.cloudflared/
        dest: /etc/cloudflared/
        remote_src: true
        owner: root
        group: root
        mode: preserve
        directory_mode: "0755"
      when: cloudflared_user_dir_stat.stat.isdir | default(false)
      notify: Reload systemd and restart cloudflared

    - name: Remove ~/.cloudflared directory from user after copying
      ansible.builtin.file:
        path: /home/{{ user }}/.cloudflared
        state: absent
      when: cloudflared_user_dir_stat.stat.isdir | default(false)

    - name: Copy cloudflared config.yml to /etc/cloudflared (authoritative)
      ansible.builtin.copy:
        src: files/cloudflare.config.yml
        dest: /etc/cloudflared/config.yml
        owner: root
        group: root
        mode: "0644"
        force: true
      notify: Reload systemd and restart cloudflared

    - name: Check if cloudflared systemd service is installed
      ansible.builtin.stat:
        path: /etc/systemd/system/cloudflared.service
      register: cloudflared_service_unit

    - name: Install cloudflared systemd service (cloudflared service install)
      ansible.builtin.command: cloudflared service install
      args:
        creates: /etc/systemd/system/cloudflared.service
      when: not cloudflared_service_unit.stat.exists
      notify: Reload systemd and restart cloudflared

    - name: Ensure cloudflared service is enabled and started
      ansible.builtin.systemd:
        name: cloudflared
        state: started
        enabled: true
        daemon_reload: true

    - name: Show cloudflared service status
      ansible.builtin.command: systemctl status cloudflared --no-pager
      register: cloudflared_status
      changed_when: false
      failed_when: false

    - name: Check if Docker is already installed
      ansible.builtin.command: which docker
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Download Docker convenience script
      get_url:
        url: https://get.docker.com
        dest: /tmp/get-docker.sh
        mode: '0755'
      when: docker_check.rc != 0

    - name: Run Docker convenience script
      command: /tmp/get-docker.sh
      args:
        creates: /usr/bin/docker
      when: docker_check.rc != 0

    - name: Check if Docker service exists
      command: systemctl list-unit-files | grep docker
      register: docker_service_check
      failed_when: false
      changed_when: false

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: true
      when:
        - not ansible_check_mode
        - "'docker.service' in docker_service_check.stdout"

    - name: Verify Docker is running
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Check if docker group exists
      command: getent group docker
      register: docker_group_check
      failed_when: false
      changed_when: false

    - name: Add user to docker group
      user:
        name: "{{ user }}"
        groups: docker
        append: true
      when:
        - not ansible_check_mode
        - docker_group_check.rc == 0

    - name: Clean up Docker script
      file:
        path: /tmp/get-docker.sh
        state: absent
      when: docker_check.rc != 0

    - name: Ensure fish config directory exists
      ansible.builtin.file:
        path: /home/{{ user }}/.config/fish
        state: directory
        mode: "0755"
        owner: "{{ user }}"
        group: "{{ user }}"

    - name: Copy fish config file
      ansible.builtin.copy:
        src: files/config.fish
        dest: /home/{{ user }}/.config/fish/config.fish
        mode: "0644"
        owner: "{{ user }}"
        group: "{{ user }}"
        force: true

    - name: Ensure /srv directory exists
      ansible.builtin.file:
        path: /srv
        state: directory
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: "0750"

    - name: Synchronize Docker configurations to /srv/docker
      ansible.posix.synchronize:
        src: ../docker/
        dest: /srv/docker/
        delete: no
        recursive: yes
        rsync_opts:
          - "--exclude=*.example"
          - "--exclude=jellyfin/cache/"
          - "--exclude=jellyfin/config/"
      become: false

    - name: Set /srv/docker ownership and permissions
      ansible.builtin.file:
        path: /srv/docker
        state: directory
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: "0750"
        recurse: yes

  handlers:
    - name: Reload systemd and restart cloudflared
      ansible.builtin.systemd:
        name: cloudflared
        state: restarted
        enabled: true
        daemon_reload: true
